# Описание деталей имплементации

## Вопросы (ответы)

1. Проверить мою реализацию superRepository в чатике(гпт) Она очевидно плохая, т.к. циклические зависимости появились.

## Сервисы

* auth
* api (router)
* orders
* сервис взаимодействия с accrual

### Auth

Реализовать JWT
Реализовать проверку, что пользователь является владельцем заказа.

Задачи:

* регистрация
* аутентификация
* авторизация (проверка соответствеия userid в заказе?)

Хендлеры:

* `POST /api/user/register` — регистрация пользователя;
* `POST /api/user/login` — аутентификация пользователя;

### Orders

Задачи:

* приём номеров заказов от зарегистрированных пользователей (?что такое прием номеров, для чего?)
* учёт и ведение списка переданных номеров заказов зарегистрированного пользователя;
* учёт и ведение накопительного счёта зарегистрированного пользователя;
* проверка принятых номеров заказов через систему расчёта баллов лояльности;
* начисление за каждый подходящий номер заказа положенного вознаграждения на счёт лояльности пользователя.

Хендлеры:

* `POST /api/user/orders` — загрузка пользователем номера заказа для расчёта;
* `GET /api/user/orders` — получение списка загруженных пользователем номеров заказов, статусов их обработки и информации о начислениях;
* `GET /api/user/balance` — получение текущего баланса счёта баллов лояльности пользователя;
* `POST /api/user/balance/withdraw` — запрос на списание баллов с накопительного счёта в счёт оплаты нового заказа;
* `GET /api/user/withdrawals` — получение информации о выводе средств с накопительного счёта пользователем.

! списания должны быть атомарными, баланс не отрицательный

### Сервис взаимодействия с accrual

Асинхронный сервис. Запускается в фоне с заданной периодичностью.

* обращается к accrual `GET /api/orders/{number}`
* при получении статуса `INVALID` маркирует заказ как обработанный, баллы не начисляет
* при получении статуса `PROCESSED` маркирует заказ как обработанный и добавляет владельцу этих заказов баллы на счёт
* при получении статуса `204` - заказ не зарегистрирован в системе расчета переносит проверку на следующую итерацию (либо изначально не проверяет заказы не промаркированные как зарегистрированные)
* при получении статуса `500` делает N повторений после чего переносит проверку на следующую итерацию
* при получении статуса `429` — превышено количество запросов !Retry-After: 60 нужно обработать

## База данных

!подумать над добавлением таблицы balance

Таблицы:

* users
* orders
* withdrawals

Таблица users:

* id
* login
* password_hash

Таблица orders:

* id
* user_id
* number
* status

Таблица withdrawals:

* id
* user_id
* order_number
* sum

## Конфигурация

Перейти на viper
